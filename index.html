<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>圣诞树抽礼物</title>
    <style>
      :root {
        --bg-top: #0b1220;
        --bg-mid: #0f1f38;
        --bg-bottom: #162b4a;
        --tree-dark: #0f4f3a;
        --tree-light: #166b4e;
        --gold: #f6c453;
        --red: #d94b4b;
        --blue: #4ea4ff;
        --pink: #ff8bb0;
        --snow: #f5f5f5;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Averia Serif Libre", "Noto Serif SC", serif;
        color: #f5f7fb;
        background:
          radial-gradient(1200px 500px at 50% -10%, #2a4a75 0%, transparent 70%),
          linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 40%, var(--bg-bottom) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px 16px 48px;
      }

      #glCanvas {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .scene {
        width: min(960px, 100%);
        display: grid;
        gap: 28px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        align-items: center;
        position: relative;
        z-index: 1;
      }

      .panel {
        position: relative;
        background: rgba(10, 16, 30, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 24px;
        backdrop-filter: blur(6px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
      }

      h1 {
        margin: 0 0 12px;
        font-size: clamp(28px, 4vw, 44px);
        letter-spacing: 1px;
      }

      p {
        margin: 0 0 16px;
        line-height: 1.6;
        color: rgba(245, 247, 251, 0.85);
      }

      .gift-button {
        appearance: none;
        border: none;
        background: linear-gradient(120deg, var(--gold), #ffdf8c);
        color: #3a2a06;
        font-weight: 700;
        padding: 14px 22px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 12px 24px rgba(246, 196, 83, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .gift-button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .gift-button:hover:not(:disabled) {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 16px 30px rgba(246, 196, 83, 0.45);
      }

      .result {
        margin-top: 16px;
        padding: 16px;
        border-radius: 14px;
        background: rgba(22, 35, 58, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
        min-height: 88px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
        overflow: hidden;
      }

      .result strong {
        font-size: 20px;
        color: #fff7e2;
      }

      .sparkle {
        position: relative;
        overflow: hidden;
      }

      .sparkle::after {
        content: "";
        position: absolute;
        inset: -50%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.35) 0%, transparent 60%);
        opacity: 0;
        pointer-events: none;
        animation: sparkle 2.6s ease infinite;
      }

      @keyframes sparkle {
        0%,
        100% {
          opacity: 0;
          transform: translateY(30%);
        }
        40% {
          opacity: 0.5;
        }
        70% {
          opacity: 0;
          transform: translateY(-20%);
        }
      }

      .tree-wrap {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        min-height: 420px;
      }

      .tree-gifts {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 3;
      }

      .tree-gift {
        position: absolute;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(12, 22, 36, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35);
        color: #f8f1dd;
        transform: translate(-50%, -50%);
        animation: hang 0.8s ease forwards;
      }

      .tree-gift svg {
        width: 100%;
        height: 100%;
        display: block;
        filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.35));
      }

      .tree-gift .glow {
        position: absolute;
        inset: -12%;
        background: radial-gradient(circle, currentColor 0%, transparent 65%);
        opacity: 0.35;
        filter: blur(6px);
        animation: pulse 2.2s ease-in-out infinite;
      }

      .tree-gift[data-theme="warm"] {
        color: #f6c453;
      }

      .tree-gift[data-theme="cool"] {
        color: #74b6ff;
      }

      .tree-gift[data-theme="soft"] {
        color: #ff9cbc;
      }

      .tree {
        position: relative;
        z-index: 1;
      }

      .snow {
        z-index: 2;
      }

      .tree {
        width: min(360px, 80vw);
        height: auto;
        filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.45));
      }

      .ornament {
        animation: float 3.8s ease-in-out infinite;
        transform-origin: center;
      }

      .ornament.delay-1 {
        animation-delay: 0.6s;
      }

      .ornament.delay-2 {
        animation-delay: 1.2s;
      }

      .ornament.delay-3 {
        animation-delay: 1.8s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-6px);
        }
      }

      .snow {
        position: absolute;
        inset: 0;
        overflow: hidden;
        pointer-events: none;
      }

      .snow span {
        position: absolute;
        top: -10%;
        width: 6px;
        height: 6px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        filter: blur(0.3px);
        animation: fall linear infinite;
      }

      @keyframes fall {
        to {
          transform: translateY(120vh);
        }
      }

      .reset {
        margin-top: 12px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #f2f6ff;
        padding: 10px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.2s ease, border 0.2s ease;
      }

      .reset:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .gift-list {
        margin: 18px 0 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 10px;
        color: rgba(245, 247, 251, 0.75);
        font-size: 14px;
      }

      .gift-list li {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(246, 196, 83, 0.2);
        color: #ffdf8c;
        font-size: 12px;
      }

      .gift-effect {
        position: absolute;
        inset: 0;
        opacity: 0;
        pointer-events: none;
      }

      .gift-effect.active {
        animation: gift-pop 1.4s ease forwards;
      }

      .gift-effect::before,
      .gift-effect::after {
        content: "";
        position: absolute;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.6);
        opacity: 0;
      }

      .gift-effect.active::before {
        width: 60px;
        height: 60px;
        top: 10%;
        left: 12%;
        animation: ring 1.2s ease forwards;
      }

      .gift-effect.active::after {
        width: 90px;
        height: 90px;
        bottom: 5%;
        right: 15%;
        animation: ring 1.2s ease forwards 0.1s;
      }

      .gift-effect .ribbon {
        position: absolute;
        inset: 18% 10%;
        border-radius: 18px;
        background: linear-gradient(120deg, rgba(246, 196, 83, 0.2), rgba(255, 255, 255, 0));
        mix-blend-mode: screen;
        opacity: 0;
      }

      .gift-effect.active .ribbon {
        animation: ribbon 1.2s ease forwards;
      }

      .gift-effect[data-theme="warm"] .ribbon {
        background: linear-gradient(120deg, rgba(217, 75, 75, 0.35), rgba(255, 255, 255, 0));
      }

      .gift-effect[data-theme="cool"] .ribbon {
        background: linear-gradient(120deg, rgba(78, 164, 255, 0.35), rgba(255, 255, 255, 0));
      }

      .gift-effect[data-theme="soft"] .ribbon {
        background: linear-gradient(120deg, rgba(255, 139, 176, 0.35), rgba(255, 255, 255, 0));
      }

      @keyframes gift-pop {
        0% {
          opacity: 0;
          transform: scale(0.96);
        }
        40% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: scale(1.02);
        }
      }

      @keyframes ring {
        0% {
          opacity: 0;
          transform: scale(0.4);
        }
        60% {
          opacity: 0.7;
        }
        100% {
          opacity: 0;
          transform: scale(1.2);
        }
      }

      @keyframes ribbon {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        30% {
          opacity: 0.7;
        }
        100% {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      @keyframes hang {
        0% {
          opacity: 0;
          transform: translate(-50%, -60%) scale(0.9);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.25;
          transform: scale(0.95);
        }
        50% {
          opacity: 0.55;
          transform: scale(1.05);
        }
      }

      @media (max-width: 720px) {
        .tree-wrap {
          min-height: 360px;
        }
        .panel {
          padding: 20px;
        }
        .gift-button,
        .reset {
          width: 100%;
        }
        .result {
          min-height: 72px;
        }
      }
    </style>
  </head>
  <body>
    <div class="scene">
      <section class="panel sparkle">
        <h1>圣诞树抽礼物</h1>
        <p>点亮圣诞树，抽一份你的节日礼物。每次抽取会从礼物池里随机挑选。</p>
        <button class="gift-button" id="drawButton">抽一次</button>
        <button class="reset" id="resetButton">重置抽取记录</button>
        <div class="result" id="result">
          <span>还没有抽取礼物</span>
          <strong>好运正在路上</strong>
          <div class="gift-effect" id="giftEffect" data-theme="warm">
            <div class="ribbon"></div>
          </div>
        </div>
        <ul class="gift-list" id="giftList"></ul>
      </section>

      <div class="tree-wrap">
        <div class="snow" aria-hidden="true">
          <span style="left: 15%; animation-duration: 12s; animation-delay: 0s;"></span>
          <span style="left: 32%; animation-duration: 9s; animation-delay: 2s;"></span>
          <span style="left: 48%; animation-duration: 10s; animation-delay: 1s;"></span>
          <span style="left: 63%; animation-duration: 11s; animation-delay: 3s;"></span>
          <span style="left: 78%; animation-duration: 8s; animation-delay: 1.6s;"></span>
          <span style="left: 90%; animation-duration: 13s; animation-delay: 2.8s;"></span>
        </div>
        <svg class="tree" viewBox="0 0 320 460" role="img" aria-label="装饰圣诞树">
          <defs>
            <linearGradient id="treeGrad" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#1a7f5b" />
              <stop offset="100%" stop-color="#0f4f3a" />
            </linearGradient>
            <linearGradient id="trunkGrad" x1="0" x2="1" y1="0" y2="0">
              <stop offset="0%" stop-color="#704b28" />
              <stop offset="100%" stop-color="#5a3a1e" />
            </linearGradient>
            <linearGradient id="garland" x1="0" x2="1" y1="0" y2="0">
              <stop offset="0%" stop-color="#f6c453" />
              <stop offset="100%" stop-color="#ffdf8c" />
            </linearGradient>
          </defs>
          <path
            d="M160 22 L75 145 L120 145 L50 255 L110 255 L30 380 L290 380 L210 255 L270 255 L200 145 L245 145 Z"
            fill="url(#treeGrad)"
          />
          <path d="M90 188 C150 208 190 204 235 184" stroke="url(#garland)" stroke-width="4" fill="none" />
          <path d="M78 255 C150 284 205 270 255 247" stroke="url(#garland)" stroke-width="4" fill="none" />
          <path d="M65 320 C150 350 220 335 265 310" stroke="url(#garland)" stroke-width="4" fill="none" />
          <rect x="135" y="385" width="50" height="55" rx="6" fill="url(#trunkGrad)" />
          <polygon points="160 5 170 28 195 28 175 43 182 67 160 52 138 67 145 43 125 28 150 28" fill="#f6c453" />
          <circle class="ornament" cx="120" cy="170" r="10" fill="#d94b4b" />
          <circle class="ornament delay-1" cx="195" cy="190" r="8" fill="#4ea4ff" />
          <circle class="ornament delay-2" cx="95" cy="245" r="9" fill="#ff8bb0" />
          <circle class="ornament delay-3" cx="220" cy="250" r="10" fill="#f6c453" />
          <circle class="ornament delay-1" cx="70" cy="315" r="8" fill="#d94b4b" />
          <circle class="ornament delay-2" cx="245" cy="320" r="9" fill="#4ea4ff" />
          <path d="M80 220 C140 240 180 230 240 210" stroke="rgba(255,255,255,0.6)" stroke-width="3" fill="none" />
          <path d="M70 290 C140 320 200 300 250 280" stroke="rgba(255,255,255,0.5)" stroke-width="3" fill="none" />
        </svg>
        <div class="tree-gifts" id="treeGifts" aria-hidden="true"></div>
      </div>
    </div>

    <canvas id="glCanvas" aria-hidden="true"></canvas>

    <script>
      const gifts = [
        "热可可礼券",
        "圣诞袜盲盒",
        "冬日电影票",
        "手作烘焙体验",
        "暖心围巾",
        "节日香氛蜡烛",
        "圣诞书单一本",
        "小小加薪红包",
        "限量热饮杯",
        "惊喜神秘礼物",
      ];

      const storageKey = "xmas-gift-draws";
      const drawButton = document.getElementById("drawButton");
      const resetButton = document.getElementById("resetButton");
      const result = document.getElementById("result");
      const giftList = document.getElementById("giftList");
      const giftEffect = document.getElementById("giftEffect");
      const treeGifts = document.getElementById("treeGifts");

      const giftThemes = {
        "热可可礼券": "warm",
        "圣诞袜盲盒": "soft",
        "冬日电影票": "cool",
        "手作烘焙体验": "warm",
        "暖心围巾": "soft",
        "节日香氛蜡烛": "warm",
        "圣诞书单一本": "cool",
        "小小加薪红包": "warm",
        "限量热饮杯": "cool",
        "惊喜神秘礼物": "soft",
      };

      const themeColors = {
        warm: [0.85, 0.35, 0.35],
        cool: [0.3, 0.64, 1.0],
        soft: [1.0, 0.55, 0.7],
      };

      const giftVisuals = {
        "热可可礼券": { theme: "warm", width: 70, height: 50, icon: "ticket" },
        "圣诞袜盲盒": { theme: "soft", width: 64, height: 64, icon: "stocking" },
        "冬日电影票": { theme: "cool", width: 74, height: 46, icon: "film" },
        "手作烘焙体验": { theme: "warm", width: 62, height: 60, icon: "cookie" },
        "暖心围巾": { theme: "soft", width: 70, height: 50, icon: "scarf" },
        "节日香氛蜡烛": { theme: "warm", width: 60, height: 68, icon: "candle" },
        "圣诞书单一本": { theme: "cool", width: 66, height: 60, icon: "book" },
        "小小加薪红包": { theme: "warm", width: 60, height: 64, icon: "envelope" },
        "限量热饮杯": { theme: "cool", width: 58, height: 68, icon: "cup" },
        "惊喜神秘礼物": { theme: "soft", width: 70, height: 70, icon: "gift" },
      };

      function iconSvg(icon, theme) {
        const color = theme === "cool" ? "#7bb7ff" : theme === "soft" ? "#ff9cbc" : "#f6c453";
        const accent = theme === "cool" ? "#2b6cb0" : theme === "soft" ? "#d64d79" : "#b36a10";
        switch (icon) {
          case "ticket":
            return `
              <svg viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="14" width="108" height="52" rx="10" fill="${color}" />
                <path d="M28 14 v52" stroke="${accent}" stroke-width="4" stroke-dasharray="6 6"/>
                <circle cx="78" cy="40" r="10" fill="${accent}" opacity="0.6"/>
              </svg>
            `;
          case "stocking":
            return `
              <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <path d="M28 10 h30 v40 c0 22 20 30 32 30 v26 h-40 c-18 0-32-14-32-32 v-12 c0-14 6-26 10-32z" fill="${color}"/>
                <rect x="22" y="4" width="48" height="14" rx="6" fill="${accent}"/>
              </svg>
            `;
          case "film":
            return `
              <svg viewBox="0 0 140 80" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="12" width="120" height="56" rx="12" fill="${color}"/>
                <rect x="38" y="22" width="64" height="36" rx="6" fill="${accent}" opacity="0.7"/>
                <g fill="#0b1220">
                  <rect x="16" y="20" width="10" height="8" rx="2"/>
                  <rect x="16" y="36" width="10" height="8" rx="2"/>
                  <rect x="16" y="52" width="10" height="8" rx="2"/>
                  <rect x="114" y="20" width="10" height="8" rx="2"/>
                  <rect x="114" y="36" width="10" height="8" rx="2"/>
                  <rect x="114" y="52" width="10" height="8" rx="2"/>
                </g>
              </svg>
            `;
          case "cookie":
            return `
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="36" fill="${color}"/>
                <circle cx="34" cy="42" r="6" fill="${accent}" opacity="0.7"/>
                <circle cx="60" cy="34" r="5" fill="${accent}" opacity="0.7"/>
                <circle cx="64" cy="60" r="6" fill="${accent}" opacity="0.7"/>
              </svg>
            `;
          case "scarf":
            return `
              <svg viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                <rect x="18" y="26" width="84" height="22" rx="10" fill="${color}"/>
                <rect x="36" y="46" width="18" height="30" rx="8" fill="${accent}"/>
                <rect x="64" y="46" width="18" height="30" rx="8" fill="${accent}"/>
              </svg>
            `;
          case "candle":
            return `
              <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <rect x="26" y="40" width="48" height="60" rx="10" fill="${color}"/>
                <path d="M50 10 C62 26 42 36 50 48 C36 40 36 24 50 10" fill="${accent}"/>
              </svg>
            `;
          case "book":
            return `
              <svg viewBox="0 0 120 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 18 h40 v64 h-40 c-8 0-14-6-14-14 v-36 c0-8 6-14 14-14z" fill="${color}"/>
                <path d="M60 18 h40 c8 0 14 6 14 14 v36 c0 8-6 14-14 14 h-40z" fill="${accent}"/>
              </svg>
            `;
          case "envelope":
            return `
              <svg viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg">
                <rect x="12" y="18" width="96" height="54" rx="10" fill="${color}"/>
                <path d="M12 20 L60 52 L108 20" stroke="${accent}" stroke-width="6" fill="none"/>
              </svg>
            `;
          case "cup":
            return `
              <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                <rect x="26" y="30" width="48" height="62" rx="12" fill="${color}"/>
                <rect x="34" y="20" width="32" height="10" rx="5" fill="${accent}"/>
                <path d="M74 40 h10 c8 0 12 8 6 16 l-6 10 h-10" stroke="${accent}" stroke-width="6" fill="none"/>
              </svg>
            `;
          case "gift":
          default:
            return `
              <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="46" width="80" height="56" rx="12" fill="${color}"/>
                <rect x="20" y="34" width="80" height="16" rx="8" fill="${accent}"/>
                <rect x="56" y="34" width="8" height="68" fill="#f5f5f5"/>
                <path d="M44 26 c0-10 16-10 16 0 c0 6-8 10-16 10" fill="${color}"/>
                <path d="M76 26 c0-10-16-10-16 0 c0 6 8 10 16 10" fill="${color}"/>
              </svg>
            `;
        }
      }

      function seededRandom(seed) {
        let hash = 2166136261;
        for (let i = 0; i < seed.length; i += 1) {
          hash ^= seed.charCodeAt(i);
          hash = Math.imul(hash, 16777619);
        }
        return () => {
          hash += 0x6d2b79f5;
          let t = Math.imul(hash ^ (hash >>> 15), 1 | hash);
          t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }

      function layoutTreeGifts(draws) {
        treeGifts.innerHTML = "";
        const wrap = document.querySelector(".tree-wrap");
        const rect = wrap.getBoundingClientRect();
        const area = {
          left: rect.width * 0.22,
          right: rect.width * 0.78,
          top: rect.height * 0.08,
          bottom: rect.height * 0.82,
        };
        const placed = [];
        draws.forEach((gift, index) => {
          const visual = giftVisuals[gift] || {
            theme: giftThemes[gift] || "warm",
            width: 64,
            height: 64,
            icon: "gift",
          };
          const tag = document.createElement("div");
          tag.className = "tree-gift";
          tag.dataset.theme = visual.theme;
          tag.style.width = `${visual.width}px`;
          tag.style.height = `${visual.height}px`;
          tag.innerHTML = `<div class="glow"></div>${iconSvg(visual.icon, visual.theme)}`;
          treeGifts.appendChild(tag);

          const rng = seededRandom(`${gift}-${index}`);
          let placedRect = null;
          for (let attempt = 0; attempt < 40; attempt += 1) {
            const x = area.left + rng() * (area.right - area.left);
            const y = area.top + rng() * (area.bottom - area.top);
            const rectBox = {
              left: x - visual.width / 2,
              right: x + visual.width / 2,
              top: y - visual.height / 2,
              bottom: y + visual.height / 2,
            };
            const overlaps = placed.some((p) =>
              !(rectBox.right < p.left + 6 || rectBox.left > p.right - 6 || rectBox.bottom < p.top + 6 || rectBox.top > p.bottom - 6)
            );
            if (!overlaps) {
              placedRect = rectBox;
              tag.style.left = `${x}px`;
              tag.style.top = `${y}px`;
              placed.push(rectBox);
              break;
            }
          }
          if (!placedRect) {
            const fallbackX = area.left + ((index + 1) / (draws.length + 1)) * (area.right - area.left);
            const fallbackY = area.top + (index % 3) * (visual.height + 12);
            tag.style.left = `${fallbackX}px`;
            tag.style.top = `${fallbackY}px`;
            placed.push({
              left: fallbackX - visual.width / 2,
              right: fallbackX + visual.width / 2,
              top: fallbackY - visual.height / 2,
              bottom: fallbackY + visual.height / 2,
            });
          }
        });
      }

      const webgl = (() => {
        const canvas = document.getElementById("glCanvas");
        const gl = canvas.getContext("webgl", { antialias: true, premultipliedAlpha: false });
        if (!gl) return null;

        const vertexSource = `
          attribute vec2 aPosition;
          attribute vec4 aColor;
          attribute float aSize;
          varying vec4 vColor;
          void main() {
            gl_Position = vec4(aPosition, 0.0, 1.0);
            gl_PointSize = aSize;
            vColor = aColor;
          }
        `;
        const fragmentSource = `
          precision mediump float;
          varying vec4 vColor;
          void main() {
            vec2 coord = gl_PointCoord - vec2(0.5);
            float dist = length(coord);
            float alpha = smoothstep(0.5, 0.1, dist);
            gl_FragColor = vec4(vColor.rgb, vColor.a * alpha);
          }
        `;

        function compile(type, source) {
          const shader = gl.createShader(type);
          gl.shaderSource(shader, source);
          gl.compileShader(shader);
          return shader;
        }

        const program = gl.createProgram();
        gl.attachShader(program, compile(gl.VERTEX_SHADER, vertexSource));
        gl.attachShader(program, compile(gl.FRAGMENT_SHADER, fragmentSource));
        gl.linkProgram(program);
        gl.useProgram(program);

        const positionLoc = gl.getAttribLocation(program, "aPosition");
        const colorLoc = gl.getAttribLocation(program, "aColor");
        const sizeLoc = gl.getAttribLocation(program, "aSize");

        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);

        gl.enableVertexAttribArray(positionLoc);
        gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 28, 0);
        gl.enableVertexAttribArray(colorLoc);
        gl.vertexAttribPointer(colorLoc, 4, gl.FLOAT, false, 28, 8);
        gl.enableVertexAttribArray(sizeLoc);
        gl.vertexAttribPointer(sizeLoc, 1, gl.FLOAT, false, 28, 24);

        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE);

        const stars = Array.from({ length: 160 }, () => ({
          x: Math.random() * 2 - 1,
          y: Math.random() * 2 - 1,
          size: 1.5 + Math.random() * 2.5,
          speed: 0.0002 + Math.random() * 0.0006,
          twinkle: Math.random() * Math.PI * 2,
        }));

        const bursts = [];

        function resize() {
          const ratio = Math.min(window.devicePixelRatio || 1, 2);
          canvas.width = window.innerWidth * ratio;
          canvas.height = window.innerHeight * ratio;
          gl.viewport(0, 0, canvas.width, canvas.height);
        }

        function addBurst(color) {
          for (let i = 0; i < 40; i += 1) {
            const angle = Math.random() * Math.PI * 2;
            const speed = 0.002 + Math.random() * 0.004;
            bursts.push({
              x: (Math.random() * 0.5 - 0.25),
              y: (Math.random() * 0.2 - 0.1),
              vx: Math.cos(angle) * speed,
              vy: Math.sin(angle) * speed,
              life: 1,
              size: 6 + Math.random() * 6,
              color,
            });
          }
        }

        function update() {
          const data = [];
          stars.forEach((star) => {
            star.y -= star.speed;
            if (star.y < -1.2) star.y = 1.2;
            star.twinkle += 0.02;
            const alpha = 0.3 + Math.sin(star.twinkle) * 0.2;
            data.push(star.x, star.y, 0.5, 0.7, 1.0, alpha, star.size);
          });

          for (let i = bursts.length - 1; i >= 0; i -= 1) {
            const p = bursts[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.02;
            if (p.life <= 0) {
              bursts.splice(i, 1);
              continue;
            }
            data.push(p.x, p.y, p.color[0], p.color[1], p.color[2], p.life, p.size);
          }

          gl.clearColor(0, 0, 0, 0);
          gl.clear(gl.COLOR_BUFFER_BIT);

          if (data.length) {
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(data), gl.DYNAMIC_DRAW);
            gl.drawArrays(gl.POINTS, 0, data.length / 7);
          }

          requestAnimationFrame(update);
        }

        resize();
        requestAnimationFrame(update);
        window.addEventListener("resize", resize);

        return { addBurst };
      })();

      function loadDraws() {
        const raw = localStorage.getItem(storageKey);
        if (!raw) return [];
        try {
          return JSON.parse(raw);
        } catch (error) {
          return [];
        }
      }

      function saveDraws(draws) {
        localStorage.setItem(storageKey, JSON.stringify(draws));
      }

      function renderList(draws) {
        giftList.innerHTML = "";
        gifts.forEach((gift, index) => {
          const li = document.createElement("li");
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = index + 1;
          li.appendChild(badge);
          const text = document.createElement("span");
          text.textContent = gift;
          li.appendChild(text);
          if (draws.includes(gift)) {
            text.style.textDecoration = "line-through";
            text.style.opacity = "0.5";
          }
          giftList.appendChild(li);
        });
        requestAnimationFrame(() => layoutTreeGifts(draws));
      }

      function pickGift() {
        const draws = loadDraws();
        const pool = gifts.filter((gift) => !draws.includes(gift));
        if (pool.length === 0) {
          result.innerHTML = "<span>礼物池已抽完</span><strong>请先重置</strong>";
          drawButton.disabled = true;
          return;
        }
        const pick = pool[Math.floor(Math.random() * pool.length)];
        draws.push(pick);
        saveDraws(draws);
        result.innerHTML = `<span>你抽到了</span><strong>${pick}</strong>`;
        result.appendChild(giftEffect);
        const theme = giftThemes[pick] || "warm";
        giftEffect.dataset.theme = theme;
        giftEffect.classList.remove("active");
        void giftEffect.offsetWidth;
        giftEffect.classList.add("active");
        if (webgl) {
          webgl.addBurst(themeColors[theme] || themeColors.warm);
        }
        renderList(draws);
        if (draws.length === gifts.length) {
          drawButton.disabled = true;
        }
      }

      function resetDraws() {
        localStorage.removeItem(storageKey);
        drawButton.disabled = false;
        result.innerHTML = "<span>抽取记录已清空</span><strong>再抽一份吧</strong>";
        renderList([]);
      }

      drawButton.addEventListener("click", pickGift);
      resetButton.addEventListener("click", resetDraws);

      renderList(loadDraws());
    </script>
  </body>
</html>
